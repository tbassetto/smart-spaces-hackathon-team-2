{"version":3,"sources":["encryption-transforms.js"],"names":["KEY","encryptTextProp","name","ctx","key","object","transform","transforms","encryptObject","undefined","resolve","objectType","encryptConversation","conversation","spark","internal","encryption","kms","createUnboundKeys","count","then","keys","k","kmsMessage","keyUris","includes","uri","push","all","activities","items","reduce","p","activity","encryptionKeyUrl","defaultActivityEncryptionKeyUrl","encryptActivity","verb","encryptVerbActivity","maybeEncryptTarget","target","conversationUrl","url","reject","Error","get","updateKey","updateKeyActivity","kmsResourceObjectUrl","resource","logger","warn","prepareActivityKmsMessage","kro","forEach","replace","keyUrl","encryptVerbActivityWithKey","direction","fn","encryptAddActivity","alias","encryptAssignActivity","encryptCreateActivity","encryptPostActivity","encryptShareActivity","encryptUpdateActivity","encryptUpdateKeyActivity","encryptComment","comment","encryptContent","content","promises","files","map","item","encryptFile","file","image","scr","encryptImageURI","imageURI","encryptPropContent","encryptPropDisplayName","encryptPropLocation","encryptPropScr","encryptScr","encryptText","ciphertext"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAWA;;;;;;AAEA,IAAMA,MAAM,sBAAO,KAAP,CAAZ,C,CAbA;;;;AAeA,IAAMC,kBAAkB,qBAAM,UAACC,IAAD,EAAOC,GAAP,EAAYC,GAAZ,EAAiBC,MAAjB;AAAA,SAA4BF,IAAIG,SAAJ,CAAc,iBAAd,EAAiCJ,IAAjC,EAAuCE,GAAvC,EAA4CC,MAA5C,CAA5B;AAAA,CAAN,CAAxB;;AAEA;AACO,IAAME,kCAAa,uBAAQ,UAAR,EAAoB;AAC5CC,eAD4C,yBAC9BL,GAD8B,EACzBC,GADyB,EACpBC,MADoB,EACZ;AAC9B,QAAI,CAACA,MAAL,EAAa;AACXA,eAASD,GAAT;AACAA,YAAMK,SAAN;AACD;;AAED,QAAI,CAACJ,MAAL,EAAa;AACX,aAAO,kBAAQK,OAAR,EAAP;AACD;;AAED,QAAI,CAACL,OAAOM,UAAZ,EAAwB;AACtB,aAAO,kBAAQD,OAAR,EAAP;AACD;;AAED,QAAIN,QAAQ,KAAZ,EAAmB;AACjB,aAAO,kBAAQM,OAAR,EAAP;AACD;;AAED,WAAOP,IAAIG,SAAJ,aAAwB,0BAAWD,OAAOM,UAAlB,CAAxB,EAAyDP,GAAzD,EAA8DC,MAA9D,CAAP;AACD,GApB2C;AAsB5CO,qBAtB4C,+BAsBxBT,GAtBwB,EAsBnBC,GAtBmB,EAsBdS,YAtBc,EAsBA;AAC1C,QAAIT,QAAQ,KAAZ,EAAmB;AACjB,aAAO,kBAAQM,OAAR,EAAP;AACD;AACD,WAAO,kBAAQA,OAAR,CAAgBN,OAAOD,IAAIW,KAAJ,CAAUC,QAAV,CAAmBC,UAAnB,CAA8BC,GAA9B,CAAkCC,iBAAlC,CAAoD,EAACC,OAAO,CAAR,EAApD,CAAvB,EACJC,IADI,CACC,UAACC,IAAD,EAAU;AACd,UAAMC,IAAI,uBAAQD,IAAR,IAAgBA,KAAK,CAAL,CAAhB,GAA0BA,IAApC;AACA,UAAI,mBAAIR,YAAJ,EAAkB,oBAAlB,KAA2C,CAACA,aAAaU,UAAb,CAAwBC,OAAxB,CAAgCC,QAAhC,CAAyCH,EAAEI,GAA3C,CAAhD,EAAiG;AAC/Fb,qBAAaU,UAAb,CAAwBC,OAAxB,CAAgCG,IAAhC,CAAqCL,EAAEI,GAAvC;AACD;;AAED,aAAO,kBAAQE,GAAR,CAAY;AACjB;AACA;AACA,yBAAIf,YAAJ,EAAkB,kBAAlB,KAAyCA,aAAagB,UAAb,CAAwBC,KAAxB,CAA8BC,MAA9B,CAAqC,UAACC,CAAD,EAAIC,QAAJ,EAAiB;AAC7F;AACA,eAAOD,EAAEZ,IAAF,CAAO;AAAA,iBAAMjB,IAAIG,SAAJ,CAAc,eAAd,EAA+BgB,CAA/B,EAAkCW,QAAlC,CAAN;AAAA,SAAP,CAAP;AACD,OAHwC,EAGtC,kBAAQvB,OAAR,EAHsC,CAHxB,EAOjBP,IAAIG,SAAJ,CAAc,wBAAd,EAAwCgB,CAAxC,EAA2CT,YAA3C,CAPiB,CAAZ,EASJO,IATI,CASC,YAAM;AACVP,qBAAaqB,gBAAb,GAAgCZ,EAAEI,GAAF,IAASJ,CAAzC;AACA;AACA;AACA,YAAI,CAAClB,GAAL,EAAU;AACRS,uBAAasB,+BAAb,GAA+CtB,aAAasB,+BAAb,IAAgDb,EAAEI,GAAlD,IAAyDJ,CAAxG;AACD;AACF,OAhBI,CAAP;AAiBD,KAxBI,CAAP;AAyBD,GAnD2C;AAqD5Cc,iBArD4C,2BAqD5BjC,GArD4B,EAqDvBC,GArDuB,EAqDlB6B,QArDkB,EAqDR;AAClC;AACA,QAAIA,SAASC,gBAAb,EAA+B;AAC7B,aAAO,kBAAQxB,OAAR,EAAP;AACD;;AAED,WAAOP,IAAIG,SAAJ,aAAwB,0BAAW2B,SAASI,IAApB,CAAxB,eAA6DjC,GAA7D,EAAkE6B,QAAlE,EACJb,IADI,CACC,YAAM;AACVhB,YAAMA,OAAO6B,SAASjC,GAAT,CAAb;AACA,aAAOG,IAAIG,SAAJ,CAAc,2BAAd,EAA2CF,GAA3C,EAAgD6B,QAAhD,CAAP;AACD,KAJI,CAAP;AAKD,GAhE2C;AAkE5CK,qBAlE4C,+BAkExBnC,GAlEwB,EAkEnBC,GAlEmB,EAkEd6B,QAlEc,EAkEJ;AACtC,WAAO9B,IAAIG,SAAJ,CAAc,oBAAd,EAAoCF,GAApC,EAAyC6B,QAAzC,EACJb,IADI,CACC,YAAM;AACVhB,YAAMA,OAAO6B,SAASjC,GAAT,CAAb;AACD,KAHI,EAIJoB,IAJI,CAIC;AAAA,aAAMjB,IAAIG,SAAJ,CAAc,eAAd,EAA+BF,GAA/B,EAAoC6B,SAAS5B,MAA7C,CAAN;AAAA,KAJD,CAAP;AAKD,GAxE2C;AA0E5CkC,oBA1E4C,8BA0EzBpC,GA1EyB,EA0EpBC,GA1EoB,EA0Ef6B,QA1Ee,EA0EL;AACrC;AACA;AACA,QAAI7B,GAAJ,EAAS;AACP,aAAO,kBAAQM,OAAR,EAAP;AACD;;AAED,QAAI,mBAAIuB,QAAJ,EAAc,wCAAd,KAA2D,mBAAIA,QAAJ,EAAc,6BAAd,CAA/D,EAA6G;AAC3GA,eAASjC,GAAT,IAAgBI,OAAO6B,SAASO,MAAT,CAAgBL,+BAAvC;AACA,aAAO,kBAAQzB,OAAR,EAAP;AACD;;AAED,QAAM+B,kBAAkBR,SAASO,MAAT,IAAmBP,SAASO,MAAT,CAAgBE,GAA3D;AACA,QAAI,CAACD,eAAL,EAAsB;AACpB,aAAO,kBAAQE,MAAR,CAAe,IAAIC,KAAJ,CAAU,uGAAV,CAAf,CAAP;AACD;;AAED,WAAOzC,IAAIW,KAAJ,CAAUC,QAAV,CAAmBF,YAAnB,CAAgCgC,GAAhC,CAAoC,EAACH,KAAKD,eAAN,EAApC,EACJrB,IADI,CACC,UAACP,YAAD,EAAkB;AACtB,UAAI,CAACA,aAAasB,+BAAlB,EAAmD;AACjD,eAAOhC,IAAIW,KAAJ,CAAUC,QAAV,CAAmBF,YAAnB,CAAgCiC,SAAhC,CAA0CjC,YAA1C,EACJO,IADI,CACC,UAAC2B,iBAAD,EAAuB;AAC3Bd,mBAASO,MAAT,CAAgBQ,oBAAhB,GAAuCD,kBAAkBxB,UAAlB,CAA6B0B,QAA7B,CAAsCvB,GAA7E;AACAO,mBAASjC,GAAT,IAAgBiC,SAASO,MAAT,CAAgBL,+BAAhB,GAAkDY,kBAAkB1C,MAAlB,CAAyB8B,+BAA3F;AACD,SAJI,CAAP;AAKD;;AAED,UAAI,CAACF,SAASO,MAAT,CAAgBL,+BAArB,EAAsD;AACpDhC,YAAIW,KAAJ,CAAUoC,MAAV,CAAiBC,IAAjB,CAAsB,6LAAtB;AACD;;AAED,UAAI,CAAClB,SAASO,MAAT,CAAgBQ,oBAArB,EAA2C;AACzC7C,YAAIW,KAAJ,CAAUoC,MAAV,CAAiBC,IAAjB,CAAsB,kLAAtB;AACD;;AAEDlB,eAASjC,GAAT,IAAgBiC,SAASO,MAAT,CAAgBL,+BAAhB,GAAkDtB,aAAasB,+BAA/E;AACAF,eAASO,MAAT,CAAgBQ,oBAAhB,GAAuCnC,aAAamC,oBAApD;AACA,aAAO,kBAAQtC,OAAR,EAAP;AACD,KArBI,CAAP;AAsBD,GAjH2C;AAmH5C0C,2BAnH4C,qCAmHlBjD,GAnHkB,EAmHbC,GAnHa,EAmHR6B,QAnHQ,EAmHE;AAC5C,QAAIA,SAASV,UAAb,EAAyB;AACvB,UAAI,CAACnB,GAAD,IAAQ6B,SAASI,IAAT,KAAkB,WAA1B,IAAyC,mBAAIJ,QAAJ,EAAc,wCAAd,CAA7C,EAAsG;AACpG7B,cAAM,mBAAI6B,QAAJ,EAAc,wCAAd,CAAN;AACD;;AAED,UAAI,CAAC7B,GAAD,IAAQ6B,SAASI,IAAT,KAAkB,OAA1B,IAAqC,mBAAIJ,QAAJ,EAAc,wCAAd,CAAzC,EAAkG;AAChG7B,cAAM,mBAAI6B,QAAJ,EAAc,wCAAd,CAAN;AACD;;AAED,UAAI7B,GAAJ,EAAS;AACP,YAAMiD,MAAMpB,SAASO,MAAT,CAAgBQ,oBAA5B;AACA,SAAC,KAAD,EAAQ,aAAR,EAAuBM,OAAvB,CAA+B,UAAChC,CAAD,EAAO;AACpC,cAAIW,SAASV,UAAT,CAAoBD,CAApB,KAA0B,CAAC+B,GAA3B,IAAkCpB,SAASV,UAAT,CAAoBD,CAApB,EAAuBG,QAAvB,CAAgC,OAAhC,CAAtC,EAAgF;AAC9E,kBAAM,IAAImB,KAAJ,CAAU,iCAAV,CAAN;AACD;;AAED,cAAIX,SAASV,UAAT,CAAoBD,CAApB,CAAJ,EAA4B;AAC1BW,qBAASV,UAAT,CAAoBD,CAApB,IAAyBW,SAASV,UAAT,CAAoBD,CAApB,EAAuBiC,OAAvB,CAA+B,OAA/B,EAAwCF,GAAxC,CAAzB;AACA;AACApB,qBAASV,UAAT,CAAoBD,CAApB,IAAyBW,SAASV,UAAT,CAAoBD,CAApB,EAAuBiC,OAAvB,CAA+B,UAA/B,EAA2CnD,IAAIoD,MAAJ,IAAcpD,GAAzD,CAAzB;AACD;AACF,SAVD;AAWD;AACD;AACA;AACA;AAhBA,WAiBK;AACH,wCAAuB6B,QAAvB,EAAiC,YAAjC;AACD;AACF;AACF,GAlJ2C;;;AAoJ5CwB,8BAA4B;AAC1BC,eAAW,UADe;AAE1BC,MAF0B,cAEvBxD,GAFuB,EAElBC,GAFkB,EAEb6B,QAFa,EAEH;AACrB,aAAO9B,IAAIG,SAAJ,CAAc,qBAAd,EAAqCF,GAArC,EAA0C6B,QAA1C,EACJb,IADI,CACC,YAAM;AACVhB,cAAMA,OAAO6B,SAASjC,GAAT,CAAb;AACAiC,iBAASC,gBAAT,GAA4B9B,IAAIsB,GAAJ,IAAWtB,GAAvC;AACD,OAJI,CAAP;AAKD;AARyB,GApJgB;;AA+J5CwD,sBAAoB;AAClBF,eAAW,UADO;AAElBG,WAAO;AAFW,GA/JwB;;AAoK5CC,yBAAuB;AACrBJ,eAAW,UADU;AAErBG,WAAO;AAFc,GApKqB;;AAyK5CE,yBAAuB;AACrBL,eAAW,UADU;AAErBG,WAAO;AAFc,GAzKqB;;AA8K5CG,uBAAqB;AACnBN,eAAW,UADQ;AAEnBG,WAAO;AAFY,GA9KuB;;AAmL5CI,wBAAsB;AACpBP,eAAW,UADS;AAEpBG,WAAO;AAFa,GAnLsB;;AAwL5CK,yBAAuB;AACrBR,eAAW,UADU;AAErBG,WAAO;AAFc,GAxLqB;;AA6L5CM,4BAA0B;AACxBT,eAAW,UADa;AAExBG,WAAO;AAFiB,GA7LkB;;AAkM5CO,gBAlM4C,0BAkM7BjE,GAlM6B,EAkMxBC,GAlMwB,EAkMnBiE,OAlMmB,EAkMV;AAChC,WAAO,kBAAQzC,GAAR,CAAY,CACjBzB,IAAIG,SAAJ,CAAc,wBAAd,EAAwCF,GAAxC,EAA6CiE,OAA7C,CADiB,EAEjBlE,IAAIG,SAAJ,CAAc,oBAAd,EAAoCF,GAApC,EAAyCiE,OAAzC,CAFiB,CAAZ,CAAP;AAID,GAvM2C;AAyM5CC,gBAzM4C,0BAyM7BnE,GAzM6B,EAyMxBC,GAzMwB,EAyMnBmE,OAzMmB,EAyMV;AAChC,QAAMC,WAAWD,QAAQE,KAAR,CAAc3C,KAAd,CAAoB4C,GAApB,CAAwB,UAACC,IAAD;AAAA,aAAUxE,IAAIG,SAAJ,CAAc,eAAd,EAA+BF,GAA/B,EAAoCuE,IAApC,CAAV;AAAA,KAAxB,CAAjB;AACAH,aAAS7C,IAAT,CAAcxB,IAAIG,SAAJ,CAAc,oBAAd,EAAoCF,GAApC,EAAyCmE,OAAzC,CAAd;AACAC,aAAS7C,IAAT,CAAcxB,IAAIG,SAAJ,CAAc,wBAAd,EAAwCF,GAAxC,EAA6CmE,OAA7C,CAAd;AACA,WAAO,kBAAQ3C,GAAR,CAAY4C,QAAZ,CAAP;AACD,GA9M2C;AAgN5CI,aAhN4C,uBAgNhCzE,GAhNgC,EAgN3BC,GAhN2B,EAgNtByE,IAhNsB,EAgNhB;AAC1B,QAAIA,KAAKC,KAAL,IAAc,CAACD,KAAKC,KAAL,CAAWC,GAA9B,EAAmC;AACjC,aAAO,kBAAQpC,MAAR,CAAe,IAAIC,KAAJ,CAAU,iCAAV,CAAf,CAAP;AACD;;AAED,WAAO,kBAAQhB,GAAR,CAAY,CACjBzB,IAAIG,SAAJ,CAAc,gBAAd,EAAgCF,GAAhC,EAAqCyE,IAArC,CADiB,EAEjB1E,IAAIG,SAAJ,CAAc,wBAAd,EAAwCF,GAAxC,EAA6CyE,IAA7C,CAFiB,EAGjB1E,IAAIG,SAAJ,CAAc,oBAAd,EAAoCF,GAApC,EAAyCyE,IAAzC,CAHiB,EAIjBA,KAAKC,KAAL,IAAc3E,IAAIG,SAAJ,CAAc,gBAAd,EAAgCF,GAAhC,EAAqCyE,KAAKC,KAA1C,CAJG,CAAZ,CAAP;AAMD,GA3N2C;;;AA6N5C;AACAE,iBA9N4C,2BA8N5B7E,GA9N4B,EA8NvBC,GA9NuB,EA8NlB6E,QA9NkB,EA8NR;AAClC,WAAO9E,IAAIG,SAAJ,CAAc,qBAAd,EAAqCF,GAArC,EAA0C6E,QAA1C,CAAP;AACD,GAhO2C;;;AAkO5CC,sBAAoBjF,gBAAgB,SAAhB,CAlOwB;;AAoO5CkF,0BAAwBlF,gBAAgB,aAAhB,CApOoB;;AAsO5CmF,uBAAqBnF,gBAAgB,UAAhB,CAtOuB;;AAwO5CoF,gBAxO4C,0BAwO7BlF,GAxO6B,EAwOxBC,GAxOwB,EAwOnBC,MAxOmB,EAwOX;AAC/B,QAAI,CAACA,OAAO0E,GAAZ,EAAiB;AACf,aAAO,kBAAQrE,OAAR,EAAP;AACD;;AAED,WAAOP,IAAIW,KAAJ,CAAUC,QAAV,CAAmBC,UAAnB,CAA8BsE,UAA9B,CAAyClF,GAAzC,EAA8CC,OAAO0E,GAArD,EACJ3D,IADI,CACC,UAAC2D,GAAD,EAAS;AACb1E,aAAO0E,GAAP,GAAaA,GAAb;AACD,KAHI,CAAP;AAID,GAjP2C;AAmP5C9E,iBAnP4C,2BAmP5BE,GAnP4B,EAmPvBD,IAnPuB,EAmPjBE,GAnPiB,EAmPZC,MAnPY,EAmPJ;AACtC,QAAI,CAACA,OAAOH,IAAP,CAAL,EAAmB;AACjB,aAAO,kBAAQQ,OAAR,EAAP;AACD;;AAED,WAAOP,IAAIW,KAAJ,CAAUC,QAAV,CAAmBC,UAAnB,CAA8BuE,WAA9B,CAA0CnF,IAAIsB,GAAJ,IAAWtB,GAArD,EAA0DC,OAAOH,IAAP,CAA1D,EACJkB,IADI,CACC,UAACoE,UAAD,EAAgB;AACpBnF,aAAOH,IAAP,IAAesF,UAAf;AACD,KAHI,CAAP;AAID;AA5P2C,CAApB,CAAnB","file":"encryption-transforms.js","sourcesContent":["/*!\n * Copyright (c) 2015-2017 Cisco Systems, Inc. See LICENSE file.\n */\n\nimport {\n  capitalize,\n  curry,\n  get,\n  has,\n  isArray\n} from 'lodash';\nimport toArray from './to-array';\n\nconst KEY = Symbol('KEY');\n\nconst encryptTextProp = curry((name, ctx, key, object) => ctx.transform('encryptTextProp', name, key, object));\n\n// eslint-disable-next-line import/prefer-default-export\nexport const transforms = toArray('outbound', {\n  encryptObject(ctx, key, object) {\n    if (!object) {\n      object = key;\n      key = undefined;\n    }\n\n    if (!object) {\n      return Promise.resolve();\n    }\n\n    if (!object.objectType) {\n      return Promise.resolve();\n    }\n\n    if (key === false) {\n      return Promise.resolve();\n    }\n\n    return ctx.transform(`encrypt${capitalize(object.objectType)}`, key, object);\n  },\n\n  encryptConversation(ctx, key, conversation) {\n    if (key === false) {\n      return Promise.resolve();\n    }\n    return Promise.resolve(key || ctx.spark.internal.encryption.kms.createUnboundKeys({count: 1}))\n      .then((keys) => {\n        const k = isArray(keys) ? keys[0] : keys;\n        if (has(conversation, 'kmsMessage.keyUris') && !conversation.kmsMessage.keyUris.includes(k.uri)) {\n          conversation.kmsMessage.keyUris.push(k.uri);\n        }\n\n        return Promise.all([\n          // too many implicit returns on the same line is difficult to interpret\n          // eslint-disable-next-line arrow-body-style\n          has(conversation, 'activities.items') && conversation.activities.items.reduce((p, activity) => {\n            // eslint-disable-next-line max-nested-callbacks\n            return p.then(() => ctx.transform('encryptObject', k, activity));\n          }, Promise.resolve()),\n          ctx.transform('encryptPropDisplayName', k, conversation)\n        ])\n          .then(() => {\n            conversation.encryptionKeyUrl = k.uri || k;\n            // we only want to set the defaultActivityEncryptionKeyUrl if we've\n            // bound a new key\n            if (!key) {\n              conversation.defaultActivityEncryptionKeyUrl = conversation.defaultActivityEncryptionKeyUrl || k.uri || k;\n            }\n          });\n      });\n  },\n\n  encryptActivity(ctx, key, activity) {\n    // Activity is already encrypted\n    if (activity.encryptionKeyUrl) {\n      return Promise.resolve();\n    }\n\n    return ctx.transform(`encrypt${capitalize(activity.verb)}Activity`, key, activity)\n      .then(() => {\n        key = key || activity[KEY];\n        return ctx.transform('prepareActivityKmsMessage', key, activity);\n      });\n  },\n\n  encryptVerbActivity(ctx, key, activity) {\n    return ctx.transform('maybeEncryptTarget', key, activity)\n      .then(() => {\n        key = key || activity[KEY];\n      })\n      .then(() => ctx.transform('encryptObject', key, activity.object));\n  },\n\n  maybeEncryptTarget(ctx, key, activity) {\n    // This isn't quite right; if we just go by key, we have no guarantee that\n    // we have a proper KRO available for add activities\n    if (key) {\n      return Promise.resolve();\n    }\n\n    if (has(activity, 'target.defaultActivityEncryptionKeyUrl') && has(activity, 'target.kmsResourceObjectUrl')) {\n      activity[KEY] = key || activity.target.defaultActivityEncryptionKeyUrl;\n      return Promise.resolve();\n    }\n\n    const conversationUrl = activity.target && activity.target.url;\n    if (!conversationUrl) {\n      return Promise.reject(new Error('Cannot determine encryption key for activity\\'s conversation; no key url or conversation url provided'));\n    }\n\n    return ctx.spark.internal.conversation.get({url: conversationUrl})\n      .then((conversation) => {\n        if (!conversation.defaultActivityEncryptionKeyUrl) {\n          return ctx.spark.internal.conversation.updateKey(conversation)\n            .then((updateKeyActivity) => {\n              activity.target.kmsResourceObjectUrl = updateKeyActivity.kmsMessage.resource.uri;\n              activity[KEY] = activity.target.defaultActivityEncryptionKeyUrl = updateKeyActivity.object.defaultActivityEncryptionKeyUrl;\n            });\n        }\n\n        if (!activity.target.defaultActivityEncryptionKeyUrl) {\n          ctx.spark.logger.warn('plugin-conversation: downloaded conversation to determine its defaultActivityEncryptionKeyUrl; make sure to pass all encryption related properties when calling Spark.conversation methods.');\n        }\n\n        if (!activity.target.kmsResourceObjectUrl) {\n          ctx.spark.logger.warn('plugin-conversation: downloaded conversation to determine its kmsResourceObjectUrl; make sure to pass all encryption related properties when calling Spark.conversation methods.');\n        }\n\n        activity[KEY] = activity.target.defaultActivityEncryptionKeyUrl = conversation.defaultActivityEncryptionKeyUrl;\n        activity.target.kmsResourceObjectUrl = conversation.kmsResourceObjectUrl;\n        return Promise.resolve();\n      });\n  },\n\n  prepareActivityKmsMessage(ctx, key, activity) {\n    if (activity.kmsMessage) {\n      if (!key && activity.verb === 'updateKey' && has(activity, 'object.defaultActivityEncryptionKeyUrl')) {\n        key = get(activity, 'object.defaultActivityEncryptionKeyUrl');\n      }\n\n      if (!key && activity.verb === 'leave' && has(activity, 'target.defaultActivityEncryptionKeyUrl')) {\n        key = get(activity, 'target.defaultActivityEncryptionKeyUrl');\n      }\n\n      if (key) {\n        const kro = activity.target.kmsResourceObjectUrl;\n        ['uri', 'resourceUri'].forEach((k) => {\n          if (activity.kmsMessage[k] && !kro && activity.kmsMessage[k].includes('<KRO>')) {\n            throw new Error('encrypter: cannot determine kro');\n          }\n\n          if (activity.kmsMessage[k]) {\n            activity.kmsMessage[k] = activity.kmsMessage[k].replace('<KRO>', kro);\n            // key may be a key or a key url\n            activity.kmsMessage[k] = activity.kmsMessage[k].replace('<KEYURL>', key.keyUrl || key);\n          }\n        });\n      }\n      // If we made it this far and still don't have an encryption key, assume\n      // this is a conversation that is not encrypted and we're performing an\n      // action that should not encrypt it (e.g. `leave`)\n      else {\n        Reflect.deleteProperty(activity, 'kmsMessage');\n      }\n    }\n  },\n\n  encryptVerbActivityWithKey: {\n    direction: 'outbound',\n    fn(ctx, key, activity) {\n      return ctx.transform('encryptVerbActivity', key, activity)\n        .then(() => {\n          key = key || activity[KEY];\n          activity.encryptionKeyUrl = key.uri || key;\n        });\n    }\n  },\n\n  encryptAddActivity: {\n    direction: 'outbound',\n    alias: 'encryptVerbActivity'\n  },\n\n  encryptAssignActivity: {\n    direction: 'outbound',\n    alias: 'encryptVerbActivityWithKey'\n  },\n\n  encryptCreateActivity: {\n    direction: 'outbound',\n    alias: 'encryptVerbActivity'\n  },\n\n  encryptPostActivity: {\n    direction: 'outbound',\n    alias: 'encryptVerbActivityWithKey'\n  },\n\n  encryptShareActivity: {\n    direction: 'outbound',\n    alias: 'encryptVerbActivityWithKey'\n  },\n\n  encryptUpdateActivity: {\n    direction: 'outbound',\n    alias: 'encryptVerbActivityWithKey'\n  },\n\n  encryptUpdateKeyActivity: {\n    direction: 'outbound',\n    alias: 'encryptVerbActivity'\n  },\n\n  encryptComment(ctx, key, comment) {\n    return Promise.all([\n      ctx.transform('encryptPropDisplayName', key, comment),\n      ctx.transform('encryptPropContent', key, comment)\n    ]);\n  },\n\n  encryptContent(ctx, key, content) {\n    const promises = content.files.items.map((item) => ctx.transform('encryptObject', key, item));\n    promises.push(ctx.transform('encryptPropContent', key, content));\n    promises.push(ctx.transform('encryptPropDisplayName', key, content));\n    return Promise.all(promises);\n  },\n\n  encryptFile(ctx, key, file) {\n    if (file.image && !file.image.scr) {\n      return Promise.reject(new Error('`file.image` must have an `scr`'));\n    }\n\n    return Promise.all([\n      ctx.transform('encryptPropScr', key, file),\n      ctx.transform('encryptPropDisplayName', key, file),\n      ctx.transform('encryptPropContent', key, file),\n      file.image && ctx.transform('encryptPropScr', key, file.image)\n    ]);\n  },\n\n  // TODO is this used for anything other than the now-removed stickies service?\n  encryptImageURI(ctx, key, imageURI) {\n    return ctx.transform('encryptPropLocation', key, imageURI);\n  },\n\n  encryptPropContent: encryptTextProp('content'),\n\n  encryptPropDisplayName: encryptTextProp('displayName'),\n\n  encryptPropLocation: encryptTextProp('location'),\n\n  encryptPropScr(ctx, key, object) {\n    if (!object.scr) {\n      return Promise.resolve();\n    }\n\n    return ctx.spark.internal.encryption.encryptScr(key, object.scr)\n      .then((scr) => {\n        object.scr = scr;\n      });\n  },\n\n  encryptTextProp(ctx, name, key, object) {\n    if (!object[name]) {\n      return Promise.resolve();\n    }\n\n    return ctx.spark.internal.encryption.encryptText(key.uri || key, object[name])\n      .then((ciphertext) => {\n        object[name] = ciphertext;\n      });\n  }\n});\n"]}