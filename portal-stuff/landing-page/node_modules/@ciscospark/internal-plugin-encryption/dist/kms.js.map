{"version":3,"sources":["kms.js"],"names":["contexts","kmsDetails","partialContexts","KMS","SparkPlugin","extend","keyFactory","uri","onBehalfOf","namespace","children","batcher","KMSBatcher","bindKey","kro","kroUri","key","keyUri","logger","info","reject","Error","request","method","resourceUri","then","res","createResource","userIds","keyUris","keys","reduce","uris","k","push","length","resource","addAuthorization","authIds","concat","authorizations","listAuthorizations","removeAuthorization","authId","userId","querystring","stringify","createUnboundKeys","count","all","map","asKey","fetchKey","ping","jose","JWK","jwk","prepareRequest","payload","isECDHRequest","includes","resolve","get","_getContext","context","req","Request","requestContext","_contextOnBehalfOf","wrap","serverKey","process","env","NODE_ENV","util","inspect","JSON","parse","depth","processKmsMessageEvent","event","encryption","kmsMessages","kmsMessage","index","_isECDHEMessage","isECDHMessage","Response","unwrap","catch","reason","error","stack","decryptKmsMessage","body","_getKMSStaticPubKey","kmsStaticPubKey","fields","split","header","base64url","decode","kid","timeout","config","kmsInitialTimeout","spark","internal","mercury","connect","TIMEOUT_SYMBOL","status","statusCode","message","match","warn","kmsMaxTimeout","delete","_getAuthorization","credentials","getUserToken","token","access_token","promise","_prepareContext","set","expiresIn","ephemeralKey","expirationDate","Date","now","authorization","clientInfo","credential","bearer","_getKMSCluster","_getKMSDetails","kmsCluster","details","service","device","rsaPublicKey","Context","clientId","url","serverInfo","createECDHKey","localECDHKey","cluster","toJSON","deriveEphemeralKey","originalContext","oneFlight"],"mappings":"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","file":"kms.js","sourcesContent":["/*!\n * Copyright (c) 2015-2017 Cisco Systems, Inc. See LICENSE file.\n */\n\nimport querystring from 'querystring';\nimport util from 'util';\n\nimport {safeSetTimeout} from '@ciscospark/common-timers';\nimport {oneFlight} from '@ciscospark/common';\nimport {SparkPlugin} from '@ciscospark/spark-core';\nimport {Context, Request, Response} from 'node-kms';\nimport jose from 'node-jose';\nimport {omit} from 'lodash';\n\nimport KMSBatcher, {TIMEOUT_SYMBOL} from './kms-batcher';\n\nconst contexts = new WeakMap();\nconst kmsDetails = new WeakMap();\nconst partialContexts = new WeakMap();\n\n/**\n * @class\n */\nconst KMS = SparkPlugin.extend({\n  namespace: 'Encryption',\n\n  children: {\n    batcher: KMSBatcher\n  },\n\n  /**\n   * Binds a key to a resource\n   * @param {Object} options\n   * @param {KMSResourceObject} options.kro\n   * @param {string} options.kroUri\n   * @param {Key} options.key\n   * @param {string} options.keyUri\n   * @returns {Promise<Key>}\n   */\n  bindKey({\n    kro, kroUri, key, keyUri\n  }) {\n    kroUri = kroUri || kro.uri;\n    keyUri = keyUri || key.uri;\n\n    this.logger.info('kms: binding key to resource');\n\n    /* istanbul ignore if */\n    if (!kroUri) {\n      return Promise.reject(new Error('`kro` or `kroUri` is required'));\n    }\n\n    /* istanbul ignore if */\n    if (!keyUri) {\n      return Promise.reject(new Error('`key` or `keyUri` is required'));\n    }\n\n    return this.request({\n      method: 'update',\n      resourceUri: kroUri,\n      uri: keyUri\n    })\n      .then((res) => {\n        this.logger.info('kms: bound key to resource');\n        return res.key;\n      });\n  },\n\n  /**\n   * Creates a new KMS Resource\n   * @param {Object} options\n   * @param {Array<string>} options.userIds\n   * @param {Array<string>} options.keyUris\n   * @param {Key} options.key\n   * @param {Array<Keys>} options.keys\n   * @returns {Promise<KMSResourceObject>}\n   */\n  createResource({\n    userIds, keyUris, key, keys\n  }) {\n    keyUris = keyUris || [];\n    /* istanbul ignore if */\n    if (keys) {\n      keyUris = keys.reduce((uris, k) => {\n        uris.push(k.uri);\n        return uris;\n      }, keyUris);\n    }\n\n    /* istanbul ignore else */\n    if (key) {\n      keyUris.push(key.uri);\n    }\n\n    /* istanbul ignore if */\n    if (keyUris.length === 0) {\n      return Promise.reject(new Error('Cannot create KMS Resource without at least one keyUri'));\n    }\n\n    this.logger.info('kms: creating resource');\n\n    return this.request({\n      method: 'create',\n      uri: '/resources',\n      userIds,\n      keyUris\n    })\n      .then((res) => {\n        this.logger.info('kms: created resource');\n        return res.resource;\n      });\n  },\n\n  /**\n   * Authorizes a user or KRO to a KRO\n   * @param {Object} options\n   * @param {Array<string>} options.userIds\n   * @param {Array<string>} options.authIds interchangable with userIds\n   * @param {KMSResourceObject} options.kro the target kro\n   * @param {string} options.kroUri\n   * @returns {Promise<KMSAuthorizationObject>}\n   */\n  addAuthorization({\n    userIds, authIds, kro, kroUri\n  }) {\n    userIds = userIds || [];\n    kroUri = kroUri || kro.uri;\n\n    if (authIds) {\n      userIds = userIds.concat(authIds);\n    }\n\n    /* istanbul ignore if */\n    if (userIds.length === 0) {\n      return Promise.reject(new Error('Cannot add authorization without userIds or authIds'));\n    }\n\n    /* istanbul ignore if */\n    if (!kroUri) {\n      return Promise.reject(new Error('`kro` or `kroUri` is required'));\n    }\n\n    this.logger.info('kms: adding authorization to kms resource');\n\n    return this.request({\n      method: 'create',\n      uri: '/authorizations',\n      resourceUri: kroUri,\n      userIds\n    })\n      .then((res) => {\n        this.logger.info('kms: added authorization');\n        return res.authorizations;\n      });\n  },\n\n  /**\n   * Retrieve a list of users that have been authorized to the KRO\n   * @param {Object} options\n   * @param {KMSResourceObject} options.kro the target kro\n   * @param {string} options.kroUri\n   * @returns {Array<authId>}\n   */\n  listAuthorizations({kro, kroUri}) {\n    kroUri = kroUri || kro.uri;\n    /* istanbul ignore if */\n    if (!kroUri) {\n      return Promise.reject(new Error('`kro` or `kroUri` is required'));\n    }\n    return this.request({\n      method: 'retrieve',\n      uri: `${kroUri}/authorizations`\n    })\n      .then((res) => {\n        this.logger.info('kms: retrieved authorization list');\n        return res.authorizations;\n      });\n  },\n\n  /**\n   * Deauthorizes a user or KRO from a KRO\n   * @param {Object} options\n   * @param {string} options.userId\n   * @param {string} options.authId interchangable with userIds\n   * @param {KMSResourceObject} options.kro the target kro\n   * @param {string} options.kroUri\n   * @returns {Promise<KMSAuthorizationObject>}\n   */\n  removeAuthorization({\n    authId, userId, kro, kroUri\n  }) {\n    authId = authId || userId;\n    kroUri = kroUri || kro.uri;\n\n    /* istanbul ignore if */\n    if (!authId) {\n      return Promise.reject(new Error('Cannot remove authorization without authId'));\n    }\n\n    /* istanbul ignore if */\n    if (!kroUri) {\n      return Promise.reject(new Error('`kro` or `kroUri` is required'));\n    }\n\n    this.logger.info('kms: removing authorization from kms resource');\n\n    return this.request({\n      method: 'delete',\n      uri: `${kroUri}/authorizations?${querystring.stringify({authId})}`\n    })\n      .then((res) => {\n        this.logger.info('kms: removed authorization');\n        return res.authorizations;\n      });\n  },\n\n  /**\n   * Requests `count` unbound keys from the kms\n   * @param {Object} options\n   * @param {Number} options.count\n   * @returns {Array<Key>}\n   */\n  createUnboundKeys({count}) {\n    this.logger.info(`kms: request ${count} unbound keys`);\n\n    /* istanbul ignore if */\n    if (!count) {\n      return Promise.reject(new Error('`options.count` is required'));\n    }\n\n    return this.request({\n      method: 'create',\n      uri: '/keys',\n      count\n    })\n      .then((res) => {\n        this.logger.info('kms: received unbound keys');\n        return Promise.all(res.keys.map(this.asKey));\n      });\n  },\n\n  /**\n   * Fetches the specified key from the kms\n   * @param {Object} options\n   * @param {string} options.uri\n   * @param {string} options.onBehalfOf The id of a user, upon whose behalf, the key is to be retrieved or undefined if retrieval is for the active user\n   * @returns {Promise<Key>}\n   */\n  // Ideally, this would be done via the kms batcher, but other than request id,\n  // there isn't any other userful key in a kms response to match it to a\n  // request. as such, we need the batcher to group requests, but one flight to\n  // make sure we don't make the same request multiple times.\n  @oneFlight({\n    keyFactory: ({uri, onBehalfOf}) => `${uri}/${onBehalfOf}`\n  })\n  fetchKey({uri, onBehalfOf}) {\n    /* istanbul ignore if */\n    if (!uri) {\n      return Promise.reject(new Error('`options.uri` is required'));\n    }\n\n    this.logger.info('kms: fetching key');\n\n    return this.request({\n      method: 'retrieve',\n      uri\n    }, {onBehalfOf})\n      .then((res) => {\n        this.logger.info('kms: fetched key');\n        return this.asKey(res.key);\n      });\n  },\n\n  /**\n   * Pings the kms. Mostly for testing\n   * @returns {Promise}\n   */\n  ping() {\n    return this.request({\n      method: 'update',\n      uri: '/ping'\n    });\n  },\n\n  /**\n   * Ensures a key obect is Key instance\n   * @param {Object} key\n   * @returns {Promise<Key>}\n   */\n  asKey(key) {\n    return jose.JWK.asKey(key.jwk)\n      .then((jwk) => {\n        key.jwk = jwk;\n        return key;\n      });\n  },\n\n  /**\n   * Adds appropriate metadata to the KMS request\n   * @param {Object} payload\n   * @param {Object} onBehalfOf Optional parameter to prepare the request on behalf of another user\n   * @returns {Promise<KMS.Request>}\n   */\n  prepareRequest(payload, onBehalfOf) {\n    const isECDHRequest = payload.method === 'create' && payload.uri.includes('/ecdhe');\n    return Promise.resolve(isECDHRequest ? partialContexts.get(this) : this._getContext())\n      .then((context) => {\n        this.logger.info(`kms: wrapping ${isECDHRequest ? 'ephemeral key' : 'kms'} request`);\n        const req = new Request(payload);\n        let requestContext = context;\n        if (onBehalfOf) {\n          requestContext = this._contextOnBehalfOf(context, onBehalfOf);\n        }\n        return req.wrap(requestContext, {serverKey: isECDHRequest})\n          .then(() => {\n            /* istanbul ignore else */\n            if (process.env.NODE_ENV !== 'production') {\n              this.logger.info('kms: request payload', util.inspect(omit(JSON.parse(JSON.stringify(req)), 'wrapped'), {depth: null}));\n            }\n            return req;\n          });\n      });\n  },\n\n  /**\n   * Accepts a kms message event, decrypts it, and passes it to the batcher\n   * @param {Object} event\n   * @returns {Promise<Object>}\n   */\n  processKmsMessageEvent(event) {\n    this.logger.info('kms: received kms message');\n    return Promise.all(event.encryption.kmsMessages.map((kmsMessage, index) => this._isECDHEMessage(kmsMessage)\n      .then((isECDHMessage) => {\n        this.logger.info(`kms: received ${isECDHMessage ? 'ecdhe' : 'normal'} message`);\n        const res = new Response(kmsMessage);\n        return Promise.resolve(isECDHMessage ? partialContexts.get(this) : contexts.get(this))\n          // eslint-disable-next-line max-nested-callbacks\n          .then((context) => res.unwrap(context))\n          // eslint-disable-next-line max-nested-callbacks\n          .then(() => {\n            if (process.env.NODE_ENV !== 'production') {\n              this.logger.info('kms: response payload', util.inspect(omit(JSON.parse(JSON.stringify(res)), 'wrapped'), {depth: null}));\n            }\n          })\n          // eslint-disable-next-line max-nested-callbacks\n          .then(() => { event.encryption.kmsMessages[index] = res; })\n          // eslint-disable-next-line max-nested-callbacks\n          .then(() => res);\n      })))\n      .then(() => this.batcher.processKmsMessageEvent(event))\n      .catch((reason) => {\n        this.logger.error('kms: decrypt failed', reason.stack);\n        return Promise.reject(reason);\n      })\n      .then(() => event);\n  },\n\n  /**\n   * Decrypts a kms message\n   * @param {Object} kmsMessage\n   * @returns {Promise<Object>}\n   */\n  decryptKmsMessage(kmsMessage) {\n    const res = new Response(kmsMessage);\n    return contexts.get(this)\n      .then((context) => res.unwrap(context))\n      .then(() => res.body);\n  },\n\n  /**\n   * Determines if the kms message is an ecdhe message or a normal message\n   * @param {Object} kmsMessage\n   * @returns {Promise<boolean>}\n   */\n  _isECDHEMessage(kmsMessage) {\n    return this._getKMSStaticPubKey()\n      .then((kmsStaticPubKey) => {\n        const fields = kmsMessage.split('.');\n\n        if (fields.length !== 3) {\n          return false;\n        }\n\n        const header = JSON.parse(jose.util.base64url.decode(fields[0]));\n\n        return header.kid === kmsStaticPubKey.kid;\n      });\n  },\n\n  /**\n   * Sends a request to the kms\n   * @param {Object} payload\n   * @param {Object} options\n   * @param {Number} options.timeout (internal)\n   * @param {string} options.onBehalfOf Run the request on behalf of another user (UUID), used in compliance scenarios\n   * @returns {Promise<Object>}\n   */\n  request(payload, {timeout, onBehalfOf} = {}) {\n    timeout = timeout || this.config.kmsInitialTimeout;\n\n    // Note: this should only happen when we're using the async kms batcher;\n    // once we implement the sync batcher, this'll need to be smarter.\n    return this.spark.internal.mercury.connect()\n      .then(() => this.prepareRequest(payload, onBehalfOf))\n      .then((req) => {\n        req[TIMEOUT_SYMBOL] = timeout;\n        return this.batcher.request(req);\n      })\n      // High complexity is due to attempt at test mode resiliency\n      // eslint-disable-next-line complexity\n      .catch((reason) => {\n        if (process.env.NODE_ENV === 'test' && (reason.status === 403 || reason.statusCode === 403) && reason.message.match(/Failed to resolve authorization token in KmsMessage request for user/)) {\n          this.logger.warn('kms: rerequested key due to test-mode kms auth failure');\n          return this.request(payload, {onBehalfOf});\n        }\n\n        // Ideally, most or all of the code below would go in kms-batcher, but\n        // but batching needs at least one more round of refactoring for that to\n        // work.\n        if (!reason.statusCode && !reason.status) {\n          /* istanbul ignore else */\n          if (process.env.NODE_ENV !== 'production') {\n            /* istanbul ignore next: reason.stack vs stack difficult to control in test */\n            this.logger.info('kms: request error', reason.stack || reason);\n          }\n\n          timeout *= 2;\n\n          if (timeout >= this.config.kmsMaxTimeout) {\n            this.logger.info('kms: exceeded maximum KMS request retries; negotiating new ecdh key');\n\n            /* istanbul ignore else */\n            if (process.env.NODE_ENV !== 'production') {\n              this.logger.info('kms: timeout/maxtimeout', timeout, this.config.kmsMaxTimeout);\n            }\n\n            contexts.delete(this);\n            timeout = 0;\n          }\n\n          return this.request(payload, {timeout, onBehalfOf});\n        }\n\n        return Promise.reject(reason);\n      });\n  },\n\n  /**\n   * @private\n   * @returns {Promise<string>}\n   */\n  _getAuthorization() {\n    return this.spark.credentials.getUserToken('spark:kms')\n      .then((token) => token.access_token);\n  },\n\n  @oneFlight\n  /**\n   * @private\n   * @param {String} onBehalfOf create context on behalf of another user, undefined when this is not necessary\n   * @returns {Promise<Object>}\n   */\n  _getContext() {\n    let promise = contexts.get(this);\n    if (!promise) {\n      promise = this._prepareContext();\n      contexts.set(this, promise);\n      promise.then((context) => {\n        const expiresIn = context.ephemeralKey.expirationDate - Date.now() - 30000;\n        safeSetTimeout(() => contexts.delete(this), expiresIn);\n      });\n    }\n\n    return Promise.all([\n      promise,\n      this._getAuthorization()\n    ])\n      .then(([context, authorization]) => {\n        context.clientInfo.credential.bearer = authorization;\n        return context;\n      });\n  },\n\n  /**\n   * @private\n   * @returns {Promise<Object>}\n   */\n  _getKMSCluster() {\n    this.logger.info('kms: retrieving KMS cluster');\n    return this._getKMSDetails()\n      .then(({kmsCluster}) => kmsCluster);\n  },\n\n  /**\n   * @private\n   * @returns {Promise<Object>}\n   */\n  _getKMSDetails() {\n    let details = kmsDetails.get(this);\n    if (!details) {\n      this.logger.info('kms: fetching KMS details');\n      details = this.spark.request({\n        service: 'encryption',\n        resource: `/kms/${this.spark.internal.device.userId}`\n      })\n        .then((res) => {\n          this.logger.info('kms: fetched KMS details');\n          const body = res.body;\n          body.rsaPublicKey = JSON.parse(body.rsaPublicKey);\n          return body;\n        })\n        .catch((reason) => {\n          this.logger.error('kms: failed to fetch KMS details', reason);\n          return Promise.reject(reason);\n        });\n\n      kmsDetails.set(this, details);\n    }\n\n    return details;\n  },\n\n  /**\n   * @private\n   * @returns {Promise<Object>}\n   */\n  _getKMSStaticPubKey() {\n    this.logger.info('kms: retrieving KMS static public key');\n    return this._getKMSDetails()\n      .then(({rsaPublicKey}) => rsaPublicKey);\n  },\n\n  /**\n   * @private\n   * @returns {Promise<Object>}\n   */\n  _prepareContext() {\n    this.logger.info('kms: creating context');\n    const context = new Context();\n\n    return Promise.all([\n      this._getKMSStaticPubKey(),\n      this._getAuthorization()\n    ])\n      .then(([kmsStaticPubKey, authorization]) => {\n        context.clientInfo = {\n          clientId: this.spark.internal.device.url,\n          credential: {\n            userId: this.spark.internal.device.userId,\n            bearer: authorization\n          }\n        };\n\n        context.serverInfo = {\n          key: kmsStaticPubKey\n        };\n\n        this.logger.info('kms: creating local ephemeral key');\n        return context.createECDHKey();\n      })\n      .then((localECDHKey) => {\n        context.ephemeralKey = localECDHKey;\n        partialContexts.set(this, context);\n        return Promise.all([localECDHKey.asKey(), this._getKMSCluster()]);\n      })\n      .then(([localECDHKey, cluster]) => {\n        this.logger.info('kms: submitting ephemeral key request');\n        return this.request({\n          uri: `${cluster}/ecdhe`,\n          method: 'create',\n          jwk: localECDHKey.toJSON()\n        });\n      })\n      .then((res) => {\n        this.logger.info('kms: deriving final ephemeral key');\n        return context.deriveEphemeralKey(res.key);\n      })\n      .then((key) => {\n        context.ephemeralKey = key;\n        partialContexts.delete(this);\n        this.logger.info('kms: derived final ephemeral key');\n        return context;\n      })\n      .catch((reason) => {\n        this.logger.error('kms: failed to negotiate ephemeral key', reason);\n        return Promise.reject(reason);\n      });\n  },\n\n  /**\n   * KMS 'retrieve' requests can be made on behalf of another user. This is useful\n   * for scenarios such as eDiscovery. i.e. Where an authorized compliance officer is\n   * entitled to retrieve content generated by any organisational user.\n   * As the KMSContext is cached, updating it will affect separate requests. Hence when\n   * making a request onBehalfOf another user create a new context for just this request.\n   * However this context will be 'light' as it only needs to change one field.\n   * @param {Object} originalContext - The base context to 'copy'\n   * @param {String} onBehalfOf - The user specified in the new context\n   * @returns {Context} A 'copy' of the existing context with a new user specified\n   * @private\n   */\n  _contextOnBehalfOf(originalContext, onBehalfOf) {\n    const context = new Context();\n    context.clientInfo = context.clientInfo = {\n      clientId: originalContext.clientInfo.clientId,\n      credential: {\n        userId: onBehalfOf,\n        bearer: originalContext.clientInfo.credential.bearer\n      }\n    };\n    context.serverInfo = originalContext.serverInfo;\n    context.ephemeralKey = originalContext.ephemeralKey;\n    return context;\n  }\n});\n\nexport default KMS;\n"]}