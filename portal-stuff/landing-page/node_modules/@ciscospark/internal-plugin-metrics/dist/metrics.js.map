{"version":3,"sources":["metrics.js"],"names":["Metrics","SparkPlugin","extend","children","batcher","Batcher","clientMetricsBatcher","ClientMetricsBatcher","callDiagnosticEventsBatcher","CallDiagnosticEventsBatcher","namespace","sendUnstructured","key","value","submit","request","submitClientMetrics","eventName","props","preLoginId","payload","metricName","tags","fields","type","context","timestamp","Date","now","_payload","metrics","postPreLoginMetric","aliasUser","method","api","resource","headers","body","qs","alias","spark","credentials","getClientToken","then","token","authorization","toString","submitCallDiagnosticEvents","event","eventPayload"],"mappings":";;;;;;;;;;;;;;+BAAA;;;;AAIA;;AACA;;AAEA;;;;AACA;;;;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAEA,IAAMA,UAAUC,uBAAYC,MAAZ,SASb,wBAAW,uEAAX,CATa,UAAmB;AACjCC,YAAU;AACRC,aAASC,iBADD;AAERC,0BAAsBC,8BAFd;AAGRC,iCAA6BC;AAHrB,GADuB;;AAOjCC,aAAW,SAPsB;;AAUjCC,kBAViC,4BAUhBC,GAVgB,EAUXC,KAVW,EAUJ;AAC3B,WAAO,KAAKC,MAAL,CAAYF,GAAZ,EAAiBC,KAAjB,CAAP;AACD,GAZgC;AAcjCC,QAdiC,kBAc1BF,GAd0B,EAcrBC,KAdqB,EAcd;AACjB,WAAO,KAAKT,OAAL,CAAaW,OAAb,CAAqB,sBAAc,EAACH,QAAD,EAAd,EAAqBC,KAArB,CAArB,CAAP;AACD,GAhBgC;;;AAkBjC;;;;;;;AAOAG,qBAzBiC,+BAyBbC,SAzBa,EAyBFC,KAzBE,EAyBKC,UAzBL,EAyBiB;AAChD,QAAMC,UAAU,EAACC,YAAYJ,SAAb,EAAhB;AACA,QAAIC,MAAMI,IAAV,EAAgB;AACdF,cAAQE,IAAR,GAAeJ,MAAMI,IAArB;AACD;AACD,QAAIJ,MAAMK,MAAV,EAAkB;AAChBH,cAAQG,MAAR,GAAiBL,MAAMK,MAAvB;AACD;AACD,QAAIL,MAAMM,IAAV,EAAgB;AACdJ,cAAQI,IAAR,GAAeN,MAAMM,IAArB;AACD;AACD,QAAIN,MAAMO,OAAV,EAAmB;AACjBL,cAAQK,OAAR,GAAkBP,MAAMO,OAAxB;AACD;;AAEDL,YAAQM,SAAR,GAAoBC,KAAKC,GAAL,EAApB;;AAEA,QAAIT,UAAJ,EAAgB;AACd,UAAMU,WAAW;AACfC,iBAAS,CAACV,OAAD;AADM,OAAjB;AAGA;AACA;AACA;AACA,aAAO,KAAKW,kBAAL,CAAwBF,QAAxB,EAAkCV,UAAlC,CAAP;AACD;;AAED,WAAO,KAAKb,oBAAL,CAA0BS,OAA1B,CAAkCK,OAAlC,CAAP;AACD,GArDgC;;;AAuDjC;;;;;AAKAY,WA5DiC,qBA4DvBb,UA5DuB,EA4DX;AACpB,WAAO,KAAKJ,OAAL,CAAa;AAClBkB,cAAQ,MADU;AAElBC,WAAK,SAFa;AAGlBC,gBAAU,eAHQ;AAIlBC,eAAS;AACP,6BAAqBjB;AADd,OAJS;AAOlBkB,YAAM,EAPY;AAQlBC,UAAI;AACFC,eAAO;AADL;AARc,KAAb,CAAP;AAYD,GAzEgC;AA2EjCR,oBA3EiC,8BA2EdX,OA3Ec,EA2ELD,UA3EK,EA2EO;AAAA;;AACtC,WAAO,KAAKqB,KAAL,CAAWC,WAAX,CAAuBC,cAAvB,GAAwCC,IAAxC,CAA6C,UAACC,KAAD;AAAA,aAClD,MAAK7B,OAAL,CAAa;AACXkB,gBAAQ,MADG;AAEXC,aAAK,SAFM;AAGXC,kBAAU,wBAHC;AAIXC,iBAAS;AACPS,yBAAeD,MAAME,QAAN,EADR;AAEP,+BAAqB3B;AAFd,SAJE;AAQXkB,cAAMjB;AARK,OAAb,CADkD;AAAA,KAA7C,CAAP;AAWD,GAvFgC;AAyFjC2B,4BAzFiC,sCAyFN3B,OAzFM,EAyFG;AAClC,QAAM4B,QAAQ;AACZxB,YAAM,kBADM;AAEZyB,oBAAc7B;AAFF,KAAd;AAIA,WAAO,KAAKZ,2BAAL,CAAiCO,OAAjC,CAAyCiC,KAAzC,CAAP;AACD,GA/FgC;AAAA;AAAA,CAAnB,iJAAhB;;kBAkGehD,O","file":"metrics.js","sourcesContent":["/*!\n * Copyright (c) 2015-2017 Cisco Systems, Inc. See LICENSE file.\n */\n\nimport {SparkPlugin} from '@ciscospark/spark-core';\nimport {deprecated} from '@ciscospark/common';\n\nimport Batcher from './batcher';\nimport ClientMetricsBatcher from './client-metrics-batcher';\nimport CallDiagnosticEventsBatcher from './call-diagnostic-events-batcher';\n\nconst Metrics = SparkPlugin.extend({\n  children: {\n    batcher: Batcher,\n    clientMetricsBatcher: ClientMetricsBatcher,\n    callDiagnosticEventsBatcher: CallDiagnosticEventsBatcher\n  },\n\n  namespace: 'Metrics',\n\n  @deprecated('Metrics#sendUnstructured() is deprecated; please use Metrics#submit()')\n  sendUnstructured(key, value) {\n    return this.submit(key, value);\n  },\n\n  submit(key, value) {\n    return this.batcher.request(Object.assign({key}, value));\n  },\n\n  /**\n   * This corresponds to #sendSemiStructured() in the deprecated metrics handler\n   * @param {string} eventName\n   * @param {Object} props\n   * @param {string} preLoginId\n   * @returns {Object} HttpResponse object\n   */\n  submitClientMetrics(eventName, props, preLoginId) {\n    const payload = {metricName: eventName};\n    if (props.tags) {\n      payload.tags = props.tags;\n    }\n    if (props.fields) {\n      payload.fields = props.fields;\n    }\n    if (props.type) {\n      payload.type = props.type;\n    }\n    if (props.context) {\n      payload.context = props.context;\n    }\n\n    payload.timestamp = Date.now();\n\n    if (preLoginId) {\n      const _payload = {\n        metrics: [payload]\n      };\n      // Do not batch these because pre-login events occur during onboarding, so we will be partially blind\n      // to users' progress through the reg flow if we wait to persist pre-login metrics for people who drop off because\n      // their metrics will not post from a queue flush in time\n      return this.postPreLoginMetric(_payload, preLoginId);\n    }\n\n    return this.clientMetricsBatcher.request(payload);\n  },\n\n  /**\n   * Issue request to alias a user's pre-login ID with their CI UUID\n   * @param {string} preLoginId\n   * @returns {Object} HttpResponse object\n   */\n  aliasUser(preLoginId) {\n    return this.request({\n      method: 'POST',\n      api: 'metrics',\n      resource: 'clientmetrics',\n      headers: {\n        'x-prelogin-userid': preLoginId\n      },\n      body: {},\n      qs: {\n        alias: true\n      }\n    });\n  },\n\n  postPreLoginMetric(payload, preLoginId) {\n    return this.spark.credentials.getClientToken().then((token) =>\n      this.request({\n        method: 'POST',\n        api: 'metrics',\n        resource: 'clientmetrics-prelogin',\n        headers: {\n          authorization: token.toString(),\n          'x-prelogin-userid': preLoginId\n        },\n        body: payload\n      }));\n  },\n\n  submitCallDiagnosticEvents(payload) {\n    const event = {\n      type: 'diagnostic-event',\n      eventPayload: payload\n    };\n    return this.callDiagnosticEventsBatcher.request(event);\n  }\n});\n\nexport default Metrics;\n"]}